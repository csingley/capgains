# coding: utf-8
"""
"""
# stdlib imports
import unittest
from datetime import datetime
from decimal import Decimal

#  from unittest.mock import patch


# 3rd party imports
import ofxtools


# local imports
from capgains.config import CONFIG
from capgains.ofx.scottrade import OfxStatementReader
from capgains.models.transactions import (
    Fi,
    FiAccount,
    Security,
    Transaction,
    TransactionType,
)
from common import setUpModule, tearDownModule, RollbackMixin, OfxSnippetMixin


class TradeTestCase(OfxSnippetMixin, unittest.TestCase):
    readerclass = OfxStatementReader
    ofx = """
    <INVTRANLIST><DTSTART>20100914010000.000[-4:EDT]<DTEND>20120314010000.000[-4:EDT]<BUYSTOCK><INVBUY><INVTRAN><FITID>561786865C<DTTRADE>20120227120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>45498<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-27753.78<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615057C<DTTRADE>20120224120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>13501<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-8235.61<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448657C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>6000<UNITPRICE>0.61<COMMISSION>18.3<TAXES>0<FEES>0<TOTAL>-3678.3<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615056C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>6000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-3660<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615069C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-6000<UNITPRICE>0.61<COMMISSION>18.3<TAXES>0<FEES>0<TOTAL>3641.7<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615067C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>6069.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448655C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>-6130.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448653C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>6000<UNITPRICE>0.61<COMMISSION>18.3<TAXES>0<FEES>0<TOTAL>-3678.3<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615065C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-6000<UNITPRICE>0.61<COMMISSION>18.3<TAXES>0<FEES>0<TOTAL>3641.7<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448649C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>-6130.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615051C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>10000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-6100<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615061C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>6069.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615063C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-9000<UNITPRICE>0.61<COMMISSION>34.45<TAXES>0<FEES>0<TOTAL>5455.55<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615053C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>9000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-5490<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561280142C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>41000<UNITPRICE>0.61<COMMISSION>132.05<TAXES>0<FEES>0<TOTAL>-25142.05<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561448644C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-41000<UNITPRICE>0.61<COMMISSION>132.05<TAXES>0<FEES>0<TOTAL>24877.95<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448651C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>9000<UNITPRICE>0.61<COMMISSION>34.45<TAXES>0<FEES>0<TOTAL>-5524.45<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615048C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>450<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-274.5<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615049C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>4000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-2440<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448646C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>450<UNITPRICE>0.61<COMMISSION>1.37<TAXES>0<FEES>0<TOTAL>-275.87<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448647C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>4000<UNITPRICE>0.61<COMMISSION>12.2<TAXES>0<FEES>0<TOTAL>-2452.2<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615058C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-450<UNITPRICE>0.61<COMMISSION>1.37<TAXES>0<FEES>0<TOTAL>273.13<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615059C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-4000<UNITPRICE>0.61<COMMISSION>12.2<TAXES>0<FEES>0<TOTAL>2427.8<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615055C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>31000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-18910<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448656C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>5000<UNITPRICE>0.61<COMMISSION>15.25<TAXES>0<FEES>0<TOTAL>-3065.25<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448654C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>-6130.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615066C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-10000<UNITPRICE>0.61<COMMISSION>30.5<TAXES>0<FEES>0<TOTAL>6069.5<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615068C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-5000<UNITPRICE>0.61<COMMISSION>15.25<TAXES>0<FEES>0<TOTAL>3034.75<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615050C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>13500<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-8235<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448648C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>13500<UNITPRICE>0.61<COMMISSION>41.18<TAXES>0<FEES>0<TOTAL>-8276.18<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615060C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-13500<UNITPRICE>0.61<COMMISSION>41.18<TAXES>0<FEES>0<TOTAL>8193.82<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615062C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-15000<UNITPRICE>0.61<COMMISSION>45.75<TAXES>0<FEES>0<TOTAL>9104.25<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615052C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>15000<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-9150<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448650C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>15000<UNITPRICE>0.61<COMMISSION>45.75<TAXES>0<FEES>0<TOTAL>-9195.75<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561448645C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-50000<UNITPRICE>0.61<COMMISSION>159.5<TAXES>0<FEES>0<TOTAL>30340.5<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVSELL><SELLTYPE>SELL</SELLSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561280143C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>50000<UNITPRICE>0.61<COMMISSION>159.5<TAXES>0<FEES>0<TOTAL>-30659.5<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561448652C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>2050<UNITPRICE>0.61<COMMISSION>13.25<TAXES>0<FEES>0<TOTAL>-1263.75<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVBUY><BUYTYPE>BUY</BUYSTOCK><BUYSTOCK><INVBUY><INVTRAN><FITID>561615054C<DTTRADE>20120222120000.000[-5:EST]</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>2050<UNITPRICE>0.61<COMMISSION>0<TAXES>0<FEES>0<TOTAL>-1250.5<SUBACCTSEC>CASH<SUBACCTFUND>CASH</INVBUY><BUYTYPE>BUY</BUYSTOCK><SELLSTOCK><INVSELL><INVTRAN><FITID>561615064C<DTTRADE>20120222120000.000[-5:EST]<MEMO>To Cancel a Previous Buy Transaction</INVTRAN><SECID><UNIQUEID>28413U204<UNIQUEIDTYPE>CUSIP</SECID><UNITS>-2050<UNITPRICE>0.61<COMMISSION>13.25<TAXES>0<FEES>0<TOTAL>1237.25<SUBACCTSEC>MARGIN<SUBACCTFUND>MARGIN</INVSELL><SELLTYPE>SELL</SELLSTOCK></INVTRANLIST>
    """

    def filterTradesTestCase(self):
        pass

    def filterTradeCancelsTestCase(self):
        pass

    def sortCanceledTradesTestCase(self):
        pass

    def testTradesCancel(self):
        self.reader.doTrades(self.parsed_txs)
        trans = self.reader.transactions
        self.assertEqual(len(trans), 11)
        for tran in trans:
            self.assertEqual(tran.fiaccount, self.account)
            self.assertEqual(tran.type, TransactionType.TRADE)
            self.assertEqual(tran.security, self.securities[0])
            self.assertEqual(tran.currency, "USD")

        self.assertEqual(sum([t.units for t in trans]), Decimal("149999"))
        self.assertEqual(sum([t.cash for t in trans]), Decimal("-91499.39"))

        UTC = ofxtools.utils._UTC()
        for index, (day, units, cash) in enumerate(
            [
                (22, 450, Decimal("-274.5")),
                (22, 2050, Decimal("-1250.5")),
                (22, 4000, Decimal("-2440")),
                (22, 6000, Decimal("-3660")),
                (22, 9000, Decimal("-5490")),
                (22, 10000, Decimal("-6100")),
                (22, 13500, Decimal("-8235")),
                (22, 15000, Decimal("-9150")),
                (22, 31000, Decimal("-18910")),
                (24, 13501, Decimal("-8235.61")),
                (27, 45498, Decimal("-27753.78")),
            ]
        ):
            tran = trans[index]
            self.assertEqual(tran.datetime, datetime(2012, 2, day, 17, tzinfo=UTC))
            self.assertEqual(tran.units, units)
            self.assertEqual(tran.cash, cash)


if __name__ == "__main__":
    unittest.main(verbosity=3)
